#!/bin/bash
# ==============================================================================
# 🧪 API Примеры для тестирования multitenancy
# ==============================================================================

# Настройки
DEV_HOST="https://dev-admin.x-bro.com"
PROD_HOST="https://admin.x-bro.com"

# Используем dev окружение по умолчанию
HOST="${DEV_HOST}"

echo "🌐 Используется: $HOST"
echo ""

# ==============================================================================
# 1. ЛОГИН СУПЕР-АДМИНА
# ==============================================================================
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "1️⃣  Логин супер-админа"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

LOGIN_RESPONSE=$(curl -s -X POST "${HOST}/api/superadmin/login" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "superadmin",
    "password": "super2025"
  }')

echo "Response:"
echo "$LOGIN_RESPONSE" | jq '.'
echo ""

# Извлекаем токен
TOKEN=$(echo "$LOGIN_RESPONSE" | jq -r '.token')

if [ "$TOKEN" == "null" ] || [ -z "$TOKEN" ]; then
  echo "❌ Ошибка: не удалось получить токен"
  exit 1
fi

echo "✅ Токен получен: ${TOKEN:0:20}..."
echo ""

# ==============================================================================
# 2. ПОЛУЧИТЬ СПИСОК ВСЕХ TENANTS
# ==============================================================================
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "2️⃣  Список всех tenants"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

curl -s -X GET "${HOST}/api/superadmin/tenants" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" | jq '.'

echo ""

# ==============================================================================
# 3. СОЗДАТЬ НОВЫЙ TENANT
# ==============================================================================
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "3️⃣  Создать новый tenant"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

TENANT_SLUG="testshop-$(date +%s)"
echo "Создаём tenant: $TENANT_SLUG"
echo ""

CREATE_RESPONSE=$(curl -s -X POST "${HOST}/api/superadmin/tenants" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d "{
    \"slug\": \"${TENANT_SLUG}\",
    \"name\": \"Test Shop $(date +%H:%M:%S)\"
  }")

echo "$CREATE_RESPONSE" | jq '.'
echo ""

# ==============================================================================
# 4. ПОЛУЧИТЬ TENANT ПО SLUG
# ==============================================================================
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "4️⃣  Получить tenant по slug"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

curl -s -X GET "${HOST}/api/superadmin/tenants/${TENANT_SLUG}" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" | jq '.'

echo ""

# ==============================================================================
# 5. ПОЛУЧИТЬ СПИСОК TENANTS (СНОВА)
# ==============================================================================
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "5️⃣  Список всех tenants (обновлённый)"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

curl -s -X GET "${HOST}/api/superadmin/tenants" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" | jq '.'

echo ""

# ==============================================================================
# 6. ТЕСТ БЕЗ АВТОРИЗАЦИИ (должен вернуть 401)
# ==============================================================================
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "6️⃣  Тест без авторизации (должен вернуть 401)"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

curl -s -X GET "${HOST}/api/superadmin/tenants" \
  -H "Content-Type: application/json" | jq '.'

echo ""

# ==============================================================================
# ИТОГИ
# ==============================================================================
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "✅ Тестирование завершено"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "Созданный tenant: $TENANT_SLUG"
echo "URL: https://${TENANT_SLUG}.x-bro.com"
echo ""
echo "💡 Не забудьте создать DNS запись в Cloudflare!"
echo ""
