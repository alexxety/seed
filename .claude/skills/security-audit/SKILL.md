---
name: security-audit
description: 'ะัะพะฒะตััะธ ะฟะพะปะฝัะน ะฐัะดะธั ะฑะตะทะพะฟะฐัะฝะพััะธ: ENV-ะฒะฐะปะธะดะฐัะธั, JWT (kid+jti), rate-limit, CORS whitelist, CSP, audit-logs, health checks, ะทะฐัะธัะฐ ััะฟะตั-ะฐะดะผะธะฝะบะธ.'
tags: ['security', 'best-practices', 'auth', 'api', 'saas']
---

# ๐ฏ ะฆะตะปั

ะัะธะฒะตััะธ ะฟัะพะตะบั ะบ ััะพะฒะฝั **ะผะธะฝะธะผะฐะปัะฝะพ ะฑะตะทะพะฟะฐัะฝะพะณะพ SaaS-ะฟัะพะดัะบัะฐ**, ััะพะฑั:

1. โ ะะต ะฑัะปะพ ััะตัะตะบ ENV/ัะตะบัะตัะพะฒ
2. โ ะะต ะฑัะปะพ ะฒะพะทะผะพะถะฝะพััะธ ะฟะพะฟะฐััั ะฒ ััะถะพะน tenant
3. โ ะัะต ัะพะบะตะฝั ะพะณัะฐะฝะธัะตะฝั ะฟะพ ััะพะบั ะธ ะผะพะณัั ะฑััั ะพัะพะทะฒะฐะฝั
4. โ ะัะฐะบะธ ัะธะฟะฐ brute-force, replay, CSRF, JSON pollution, Open Redirect ะฑะปะพะบะธัััััั
5. โ ะัะต ะบัะธัะธัะฝัะต ะดะตะนััะฒะธั ะปะพะณะธัััััั (ะบัะพ, ััะพ, ะบะพะณะดะฐ)
6. โ ะกัะฟะตั-ะฐะดะผะธะฝ ะฟะฐะฝะตะปั ะทะฐัะธัะตะฝะฐ ะพัะดะตะปัะฝะพ

---

# โ ะงัะพ ััะตะฑัะตััั ัะตะฐะปะธะทะพะฒะฐัั

## 1. ENV ะะะะะะะฆะะฏ

`server/src/config/env.ts` (ัะตัะตะท Zod)

โ ะัะฑะฐั ะพััััััะฒัััะฐั ะฟะตัะตะผะตะฝะฝะฐั โ ัะตัะฒะตั **ะฝะต ััะฐัััะตั**
โ ะัะต boolean/ัะธัะปะพะฒัะต ะฟะตัะตะผะตะฝะฝัะต ะฟัะธะฒะพะดัััั ะบ ัะธะฟั
โ ะะฐะทะดะตะปะธัั: `CORE`, `TENANCY`, `SECURITY`, `BILLING`, `SEARCH`, `EMAIL`

---

## 2. JWT ะะะะะะะกะะะกะขะฌ

| ััะตะฑะพะฒะฐะฝะธะต                                       | ััะฐััั             |
| ------------------------------------------------ | ------------------ |
| TTL โค 1 ัะฐั                                      | โ                 |
| ะ payload โ `sub`, `role`, `tenantId?`, `jti`    | โ                 |
| ะะพะดะดะตัะถะบะฐ `kid` (future key rotation)            | โ                 |
| ะฅัะฐะฝะธัั **ัััะฝัะน ัะฟะธัะพะบ jti** ะฒ Redis (optional) | ๐                 |
| ะกัะฟะตั-ะฐะดะผะธะฝ ะธะผะตะตั ัะฒะพั `SIGNING_KEY_SUPERADMIN`  | โ (ะดััะณะพะน ัะตะบัะตั) |

---

## 3. AUTH MIDDLEWARE

ะคะฐะนะปั:

```
server/src/middleware/authenticateToken.ts
server/src/middleware/requireRole.ts
server/src/middleware/requireTenant.ts
```

โ `authenticateToken` โ ะฟัะพะฒะตััะตั JWT, ััะพะบ, ะฟะพะดะฟะธัั, jti blacklist
โ `requireRole("superadmin")` โ ะดะพัััะฟ ัะพะปัะบะพ ััะฟะตั-ะฐะดะผะธะฝั
โ `requireTenant` โ ะทะฐะฟัะตั ะฝะฐ ะดะพัััะฟ ะฑะตะท tenantId (ัะผ. multitenancy)

---

## 4. RATE LIMITING

ะัะฟะพะปัะทะพะฒะฐัั `rate-limiter-flexible` + Redis.

| endpoint                     | ะปะธะผะธั                          |
| ---------------------------- | ------------------------------ |
| `/api/superadmin/login`      | 5 ะฟะพะฟััะพะบ / 10 ะผะธะฝัั           |
| `/api/admin/login`           | 10 ะฟะพะฟััะพะบ / 10 ะผะธะฝัั          |
| `/api/tenant/orders/:id/pay` | ะทะฐัะธัะฐ ะพั ัะฟะฐะผะฐ                |
| `/api/billing/webhook`       | ะฝะต ะปะธะผะธัะธัะพะฒะฐัั, ะฝะพ ะปะพะณะธัะพะฒะฐัั |

---

## 5. CORS / CSP / HEADERS

### CORS

ะ ENV:

```bash
CORS_ALLOWED_ORIGINS="https://admin.site.com,https://shop.site.com"
```

### CSP (Helmet)

```
default-src 'self';
script-src 'self' https:;
style-src 'self' 'unsafe-inline';
connect-src 'self' https:;
img-src 'self' data: https:;
frame-ancestors 'none';
```

### ะััะณะธะต ะทะฐะณะพะปะพะฒะบะธ

| Header                      | ะะฝะฐัะตะฝะธะต    |
| --------------------------- | ----------- |
| `X-Content-Type-Options`    | nosniff     |
| `X-Frame-Options`           | DENY        |
| `Referrer-Policy`           | no-referrer |
| `Strict-Transport-Security` | 1 year      |

---

## 6. AUDIT LOGGING

ะกะพะทะดะฐัั ัะฐะฑะปะธัั `audit_logs`:

| ะฟะพะปะต                 | ะทะฝะฐัะตะฝะธะต                                                      |
| -------------------- | ------------------------------------------------------------- |
| id                   | uuid                                                          |
| userId / superadmin? | nullable                                                      |
| tenantId             | nullable                                                      |
| action               | string (`TENANT_CREATED`, `LOGIN_FAILED`, `ORDER_PAID`, etc.) |
| meta                 | jsonb                                                         |
| ip                   | string                                                        |
| userAgent            | string                                                        |
| createdAt            | timestamp                                                     |

ะะพะณะธัะพะฒะฐัั:

- ะฃัะฟะตัะฝัะต ะธ ะฝะตััะฟะตัะฝัะต ะปะพะณะธะฝั
- ะกะพะทะดะฐะฝะธะต/ัะดะฐะปะตะฝะธะต tenant
- ะะทะผะตะฝะตะฝะธะต ัะฐัะธัะพะฒ
- ะะทะผะตะฝะตะฝะธะต ะบัะธะฟัะพ-ะฝะฐัััะพะตะบ ะฟัะพะดะฐะฒัะฐ
- ะัะฟะพะปะฝะตะฝะธะต ััะฟะตั-ะฐะดะผะธะฝ ะดะตะนััะฒะธะน
- Marketplace publish/unpublish

---

## 7. HEALTH / READY CHECKS

```
GET /healthz   โ ะฟัะพััะพ 200 OK
GET /readyz    โ ะฟัะพะฒะตััะตั: DB, Redis, Search, Queue
```

---

## 8. ะะะะะะข ะะ ะกะะะะะขะซ ะ README / GIT

โ `.env` โ ะฒ `.gitignore`
โ GitHub Actions โ ัะตะบัะตัั ัะพะปัะบะพ ัะตัะตะท `secrets.*`
โ ะัะฑัะต ัะพะบะตะฝั โ ะผะฐัะบะธัะพะฒะฐะฝั ะฒ ะปะพะณะฐั

---

## 9. ะะะฉะะขะ SUPERADMIN ะะะะะะ

| ะะตัะฐ                                            | ะะฑัะทะฐัะตะปัะฝะพ    |
| ----------------------------------------------- | -------------- |
| ะัะดะตะปัะฝัะน JWT secret                            | โ             |
| ะัะดะตะปัะฝัะน CORS whitelist                        | โ             |
| ะะณัะฐะฝะธัะธัั IP ะฟะพ ENV (`SUPERADMIN_ALLOWED_IPS`) | โ๏ธ ะถะตะปะฐัะตะปัะฝะพ  |
| ะะฑัะทะฐัะตะปัะฝะพะต 2FA (email/TOTP)                   | ๐ ะผะพะถะฝะพ ะฟะพะทะถะต |
| ะะพะณะธัะพะฒะฐะฝะธะต ะฒัะตั ะดะตะนััะฒะธะน                       | โ             |

---

# ๐งจ ะะฝัะธ-ะฐัะฐะบะธ ัะตะบะปะธัั

| ะฃะณัะพะทะฐ            | ะะฐัะธัะฐ                               |
| ----------------- | ------------------------------------ |
| Brute-force login | rate limit + audit                   |
| JWT เคเฅเคฐเฅ / reuse  | jti blacklist                        |
| SSRF              | ะทะฐะฟัะตั ะฒะฝะตัะฝะธั fetch ะบัะพะผะต allowlist |
| Webhook replay    | eventId + table `webhook_events`     |
| Tenant Escape     | `requireTenant` + `search_path`      |
| JSON pollution    | `express.json({ strict:true })`      |
| Open Redirect     | ะฑะตะปัะน ัะฟะธัะพะบ returnUrl               |
| DOS ัะตัะตะท webhook | raw-body + early exit                |

---

# โ Definition of Done (DoD)

- โ ENV-ะฒะฐะปะธะดะฐัะธั ั Zod, ัะตัะฒะตั ะฝะต ััะฐัััะตั ะฑะตะท ะฟะตัะตะผะตะฝะฝัั
- โ ะัะต JWT ะธะผะตัั TTL, jti, role, ะฟะพะดะดะตัะถะบั rotation
- โ ะกัะฟะตั-ะฐะดะผะธะฝ API ะธะทะพะปะธัะพะฒะฐะฝ: ะดััะณะพะน ะบะปัั, CORS, rate-limit
- โ `requireTenant` ะฝะต ะดะฐัั ัะธัะฐัั ััะถะธะต ะดะฐะฝะฝัะต
- โ CORS ะธ CSP ะฝะฐัััะพะตะฝั, Helmet ะฒะบะปัััะฝ
- โ Webhooks ะธะดะตะผะฟะพัะตะฝัะฝั
- โ Audit-ะปะพะณ ะฟะธัะตั ัะพะฑััะธั
- โ `/healthz` ะธ `/readyz` ัะตะฐะปะธะทะพะฒะฐะฝั
- โ README ะฝะต ัะพะดะตัะถะธั ัะตะบัะตัะพะฒ

---

# ๐ Claude Hints (ะบะฐะบ ะฒะพัะฟัะธะฝะธะผะฐัั ััะพั ัะบะธะปะป)

ะะพะณะดะฐ ัะฐะทัะฐะฑะพััะธะบ ะฟะธัะตั:

> ยซะฟัะพะฒะตัั ะฑะตะทะพะฟะฐัะฝะพััั APIยป
> ยซะดะพะฑะฐะฒั rate-limit ะฝะฐ ะปะพะณะธะฝยป
> ยซัะดะตะปะฐะน audit log ะฟัะธ ัะพะทะดะฐะฝะธะธ tenantยป
> ยซะดะพะฑะฐะฒั healthz + readyzยป

โ Claude **ะดะพะปะถะตะฝ ะธัะฟะพะปัะทะพะฒะฐัั ััะพั skill** ะธ ะฒะฝะพัะธัั ะฟัะฐะฒะบะธ ะฟะพ ัะตะบะปะธััั.
