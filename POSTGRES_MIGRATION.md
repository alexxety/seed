# PostgreSQL Migration Guide

–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å SQLite –Ω–∞ PostgreSQL + Prisma ORM

## üéØ –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

- ‚úÖ **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: SQLite ‚Üí PostgreSQL
- ‚úÖ **ORM**: better-sqlite3 ‚Üí Prisma Client
- ‚úÖ **–¢–∏–ø–∏–∑–∞—Ü–∏—è**: –ü–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ TypeScript —á–µ—Ä–µ–∑ Prisma
- ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É 2025 –≥–æ–¥–∞

## üìã –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgreSQL –Ω–∞ –¥—Ä–æ–ø–ª–µ—Ç–µ

### –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É:
```bash
ssh root@143.198.141.222
```

### –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏:
```bash
cd /var/www/telegram-shop
wget https://raw.githubusercontent.com/alexxety/seed/main/setup-postgres.sh
chmod +x setup-postgres.sh
sudo bash setup-postgres.sh
```

### –ò–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤—Ä—É—á–Ω—É—é:
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PostgreSQL
apt-get update
apt-get install -y postgresql postgresql-contrib

# –ó–∞–ø—É—Å–∫
systemctl start postgresql
systemctl enable postgresql

# –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
sudo -u postgres psql << EOF
CREATE USER seedshop WITH PASSWORD 'seedshop_secure_password_2025';
CREATE DATABASE seedshop OWNER seedshop;
GRANT ALL PRIVILEGES ON DATABASE seedshop TO seedshop;
\c seedshop
GRANT ALL ON SCHEMA public TO seedshop;
EOF
```

## üìã –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ .env –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

–î–æ–±–∞–≤—å—Ç–µ –≤ `/var/www/telegram-shop/.env`:
```bash
DATABASE_URL="postgresql://seedshop:seedshop_secure_password_2025@localhost:5432/seedshop"
```

‚ö†Ô∏è **–í–ê–ñ–ù–û**: –°–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª—å –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ!

## üìã –®–∞–≥ 3: –î–µ–ø–ª–æ–π –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏

### –ù–∞ –≤–∞—à–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ:

```bash
# 1. –°–æ–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç
npm run build

# 2. –ó–∞–∫–æ–º–º–∏—Ç—å—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
git add .
git commit -m "Migrate to PostgreSQL + Prisma ORM"
git push origin main
```

GitHub Actions –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- –ó–∞–¥–µ–ø–ª–æ–∏—Ç –∫–æ–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
- –ó–∞–ø—É—Å—Ç–∏—Ç `npm install` (–∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω–∏—Ç `prisma generate`)
- –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

## üìã –®–∞–≥ 4: –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

### –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É:
```bash
ssh root@143.198.141.222
cd /var/www/telegram-shop
```

### –°–æ–∑–¥–∞–π—Ç–µ —Ç–∞–±–ª–∏—Ü—ã —á–µ—Ä–µ–∑ Prisma:
```bash
npx prisma migrate deploy
```

### –ú–∏–≥—Ä–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ SQLite:
```bash
# –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —Å—Ç–∞—Ä–∞—è –±–∞–∑–∞ orders.db —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
ls -lh orders.db

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é
npm run db:migrate
```

–°–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–Ω–µ—Å–µ—Ç:
- ‚úÖ –í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
- ‚úÖ –í—Å–µ —Ç–æ–≤–∞—Ä—ã
- ‚úÖ –í—Å–µ –∑–∞–∫–∞–∑—ã
- ‚úÖ –°—á–µ—Ç—á–∏–∫ –∑–∞–∫–∞–∑–æ–≤

### –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä:
```bash
pm2 restart telegram-shop
# –∏–ª–∏
systemctl restart telegram-shop
```

## üìã –®–∞–≥ 5: –ü—Ä–æ–≤–µ—Ä–∫–∞

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –±–∞–∑–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç:
```bash
# –û—Ç–∫—Ä–æ–π—Ç–µ Prisma Studio (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
npx prisma studio

# –ò–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —á–µ—Ä–µ–∑ psql
sudo -u postgres psql seedshop -c "SELECT COUNT(*) FROM products;"
```

### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:
–û—Ç–∫—Ä–æ–π—Ç–µ http://143.198.141.222 –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
- ‚úÖ –¢–æ–≤–∞—Ä—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è
- ‚úÖ –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É
- ‚úÖ –ú–æ–∂–Ω–æ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
- ‚úÖ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Ä–∞–±–æ—Ç–∞–µ—Ç

## üîß –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

### Prisma:
```bash
# –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å Prisma Client
npm run prisma:generate

# –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é (dev)
npm run prisma:migrate

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ (production)
npm run prisma:migrate:prod

# –û—Ç–∫—Ä—ã—Ç—å Prisma Studio (GUI –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö)
npm run prisma:studio
```

### PostgreSQL:
```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∞–∑–µ
sudo -u postgres psql seedshop

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã
\dt

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–∞–Ω–Ω—ã–µ
SELECT * FROM products LIMIT 10;

# –í—ã–π—Ç–∏
\q
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –°–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:
```bash
sudo -u postgres psql -c "ALTER USER seedshop WITH PASSWORD '–Ω–æ–≤—ã–π_–Ω–∞–¥–µ–∂–Ω—ã–π_–ø–∞—Ä–æ–ª—å';"
```

### –û–±–Ω–æ–≤–∏—Ç–µ .env:
```bash
DATABASE_URL="postgresql://seedshop:–Ω–æ–≤—ã–π_–Ω–∞–¥–µ–∂–Ω—ã–π_–ø–∞—Ä–æ–ª—å@localhost:5432/seedshop"
```

### –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:
```bash
pm2 restart telegram-shop
```

## üö® –û—Ç–∫–∞—Ç (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫)

### –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ SQLite:
```bash
# 1. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å—Ç–∞—Ä—ã–π database.js
mv database-sqlite.js.backup database.js

# 2. –£–¥–∞–ª–∏—Ç–µ –∏–∑ package.json —Å—Ç—Ä–æ–∫—É —Å DATABASE_URL –∏–∑ .env

# 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ
pm2 restart telegram-shop
```

### –°—Ç–∞—Ä–∞—è –±–∞–∑–∞:
–§–∞–π–ª `orders.db` —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∏ –Ω–µ —É–¥–∞–ª–µ–Ω - –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –º–µ—Å—Ç–µ.

## üìä –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

- ‚úÖ **–¢–∏–ø–∏–∑–∞—Ü–∏—è**: Prisma –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç TypeScript —Ç–∏–ø—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
- ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: PostgreSQL –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–∏–ª–ª–∏–æ–Ω—ã –∑–∞–ø–∏—Å–µ–π
- ‚úÖ **–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**: ACID –≥–∞—Ä–∞–Ω—Ç–∏–∏ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ò–Ω–¥–µ–∫—Å—ã, JSONB, prepared statements
- ‚úÖ **–ú–∏–≥—Ä–∞—Ü–∏–∏**: –í–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º—ã –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ **–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã**: Prisma Studio –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã–º–∏

## ‚ùì –ü—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL:
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ PostgreSQL –∑–∞–ø—É—â–µ–Ω
systemctl status postgresql

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏
tail -f /var/log/postgresql/postgresql-*-main.log
```

### Prisma –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è:
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ .env
cat .env | grep DATABASE_URL

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
sudo -u postgres psql -c "\du"
```

### –î–∞–Ω–Ω—ã–µ –Ω–µ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å:
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –º–∏–≥—Ä–∞—Ü–∏—é —Å–Ω–æ–≤–∞ (—Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç upsert - –±–µ–∑–æ–ø–∞—Å–Ω–æ)
npm run db:migrate
```

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:
```bash
pm2 logs telegram-shop
```

–ò–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ issue –Ω–∞ GitHub: https://github.com/alexxety/seed/issues
